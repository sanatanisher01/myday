{% extends 'base.html' %}
{% load static %}

{% comment %}
This template is designed to be robust and work even if there are issues with the database or models.
It includes fallbacks for all dynamic content.
{% endcomment %}

{% block title %}Send Newsletter - MyDay{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
<style>
    .CodeMirror {
        height: 300px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
    }
    .custom-editor {
        border: 1px solid #4e73df;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(78, 115, 223, 0.1);
    }
    .content-editor-container {
        position: relative;
        border: 1px solid #4e73df;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(78, 115, 223, 0.1);
    }
    .content-editor-container .CodeMirror {
        height: 250px;
        font-size: 16px;
    }
    .alert-info {
        background-color: #e8f4fd;
        border-color: #c5e7fb;
        color: #0c63e4;
        border-radius: 8px;
    }
    .editor-toolbar {
        display: flex;
        gap: 5px;
        padding: 8px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }
    .editor-toolbar button {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s ease;
    }
    .editor-toolbar button:hover {
        background-color: #4e73df;
        color: white;
        border-color: #4e73df;
    }
    .template-preview {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        background-color: #f9f9f9;
        max-height: 400px;
        overflow-y: auto;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .subscriber-count {
        font-size: 1.2rem;
        font-weight: 600;
        color: #4e73df;
    }
    .template-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border-radius: 8px;
        overflow: hidden;
    }
    .template-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .template-card.selected {
        border: 2px solid #4e73df;
        box-shadow: 0 5px 15px rgba(78, 115, 223, 0.25);
    }
    .card {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        border: none;
    }
    .card-header {
        border-bottom: none;
        padding: 15px 20px;
    }
    .card-body {
        padding: 20px;
    }
    .form-control, .form-select {
        border-radius: 6px;
        padding: 10px 15px;
        border: 1px solid #e0e0e0;
    }
    .form-control:focus, .form-select:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
    }
    .btn-modern {
        border-radius: 6px;
        padding: 10px 20px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    .btn-gradient-primary {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        color: white;
        border: none;
    }
    .btn-gradient-primary:hover {
        background: linear-gradient(135deg, #224abe 0%, #1a3a8f 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(78, 115, 223, 0.3);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<section class="py-4">
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="mb-0 text-gradient-primary">Send Newsletter</h1>
                    <div>
                        <a href="{% url 'manager_template_list' %}" class="btn btn-modern btn-outline-info me-2">
                            <i class="fas fa-file-alt"></i> Manage Templates
                        </a>
                        <a href="{% url 'manager_dashboard' %}" class="btn btn-modern btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Dashboard
                        </a>
                    </div>
                </div>
                <hr class="gradient-line">
            </div>
        </div>

        <!-- Subscriber Stats -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">Subscriber Statistics</h5>
                                <p class="text-muted mb-0">Your newsletter reach</p>
                            </div>
                            <div class="text-end">
                                <div class="subscriber-count text-primary">{{ active_subscribers|default:"0" }} Active Subscribers</div>
                                <small class="text-muted">Out of {{ total_subscribers|default:"0" }} total subscribers</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <form method="post" action="{% url 'manager_send_newsletter' %}">
            {% csrf_token %}

            <div class="row">
                <!-- Newsletter Form -->
                <div class="col-lg-8">
                    <div class="card mb-4">
                        <div class="card-header bg-gradient-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-envelope me-2"></i>Newsletter Details</h5>
                        </div>
                        <div class="card-body">
                            {% if messages %}
                                {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                                {% endfor %}
                            {% endif %}

                            <div class="mb-3">
                                <label for="subject" class="form-label">Email Subject</label>
                                <input type="text" class="form-control" id="subject" name="subject" required placeholder="Enter a compelling subject line">
                            </div>

                            <div class="mb-3">
                                <label for="template" class="form-label">Select Template</label>
                                <div class="input-group">
                                    <select class="form-select" id="template" name="template">
                                        <option value="0">No Template (Custom Content Only)</option>
                                        {% for template in templates %}
                                        <option value="{{ template.id }}" {% if template.is_default %}selected{% endif %}>{{ template.name }}</option>
                                        {% empty %}
                                        <option value="0" disabled>No templates available</option>
                                        {% endfor %}
                                    </select>
                                    <a href="{% url 'manager_template_list' %}" class="btn btn-outline-primary">
                                        <i class="fas fa-plus"></i> Manage
                                    </a>
                                </div>
                                <small class="text-muted">
                                    Templates provide consistent styling for your newsletters.
                                    <a href="{% url 'manager_template_create' %}">Create a new template</a> if needed.
                                </small>
                            </div>

                            <div class="mb-3">
                                <label for="content" class="form-label">Custom Message</label>
                                <div class="content-editor-container">
                                    <textarea class="form-control" id="content" name="content" rows="10" placeholder="Enter your newsletter content here..."></textarea>
                                </div>
                                <div class="alert alert-info mt-2">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>How this works:</strong> Your custom message will be inserted into the selected template.
                                    You can use plain text or basic HTML formatting. This is the main content your subscribers will see.
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="send_test" name="send_test">
                                    <label class="form-check-label" for="send_test">
                                        Send a test email to yourself first
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3 d-none" id="test_email_field">
                                <label for="test_email" class="form-label">Test Email Address</label>
                                <input type="email" class="form-control" id="test_email" name="test_email" placeholder="Enter your email for testing">
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header bg-gradient-info text-white">
                            <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Recipient Options</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="recipient_option" id="all_subscribers" value="all" checked>
                                    <label class="form-check-label" for="all_subscribers">
                                        Send to all active subscribers ({{ active_subscribers|default:"0" }})
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="recipient_option" id="recent_subscribers" value="recent">
                                    <label class="form-check-label" for="recent_subscribers">
                                        Send only to subscribers from the last 30 days ({{ recent_subscribers|default:"0" }})
                                    </label>
                                </div>
                                {% if active_subscribers == 0 %}
                                <div class="alert alert-warning mt-3">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    No active subscribers found. You need to have subscribers before sending newsletters.
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preview and Submit -->
                <div class="col-lg-4">
                    <div class="card mb-4">
                        <div class="card-header bg-gradient-success text-white">
                            <h5 class="mb-0"><i class="fas fa-eye me-2"></i>Preview</h5>
                        </div>
                        <div class="card-body">
                            <div class="template-preview" id="preview">
                                <div class="text-center py-5">
                                    <i class="fas fa-envelope-open-text fa-3x text-muted mb-3"></i>
                                    <p>Your newsletter preview will appear here</p>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="previewBtn">
                                        <i class="fas fa-sync-alt me-1"></i> Generate Preview
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-lg btn-gradient-primary" id="sendBtn" name="action" value="send">
                                    <i class="fas fa-paper-plane me-2"></i>Send Newsletter
                                </button>
                                <button type="submit" class="btn btn-outline-secondary" name="action" value="save">
                                    <i class="fas fa-save me-2"></i>Save as Draft
                                </button>
                            </div>
                            <div class="text-center mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i> Sending to {{ active_subscribers|default:"0" }} subscribers
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // Initialize CodeMirror for content if available
            var contentTextarea = document.getElementById('content');
            var contentEditor;

            if (contentTextarea && typeof CodeMirror !== 'undefined') {
                try {
                    // Use a rich text editor for the custom message
                    contentEditor = CodeMirror.fromTextArea(contentTextarea, {
                        mode: 'htmlmixed',  // Allow HTML formatting
                        lineNumbers: true,
                        theme: 'default',
                        lineWrapping: true,
                        viewportMargin: Infinity,
                        placeholder: 'Enter your newsletter content here...',
                        autofocus: true,
                        autoCloseTags: true,
                        autoCloseBrackets: true,
                        matchTags: {bothTags: true},
                        extraKeys: {
                            'Ctrl-Space': 'autocomplete',
                            'Tab': function(cm) {
                                var spaces = Array(cm.getOption('indentUnit') + 1).join(' ');
                                cm.replaceSelection(spaces);
                            }
                        }
                    });

                    // Set height for better visibility
                    contentEditor.setSize(null, 250);

                    // Add custom class for styling
                    contentEditor.getWrapperElement().classList.add('custom-editor');

                    // Add a toolbar with common formatting options
                    var toolbar = document.createElement('div');
                    toolbar.className = 'editor-toolbar';
                    toolbar.innerHTML = `
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-format="bold"><i class="fas fa-bold"></i></button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-format="italic"><i class="fas fa-italic"></i></button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-format="link"><i class="fas fa-link"></i></button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-format="ul"><i class="fas fa-list-ul"></i></button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-format="ol"><i class="fas fa-list-ol"></i></button>
                    `;

                    // Insert toolbar before the editor
                    contentTextarea.parentNode.insertBefore(toolbar, contentTextarea.parentNode.firstChild);

                    // Add event listeners to toolbar buttons
                    toolbar.querySelectorAll('button').forEach(function(button) {
                        button.addEventListener('click', function() {
                            var format = this.getAttribute('data-format');
                            var doc = contentEditor.getDoc();
                            var cursor = doc.getCursor();
                            var selection = doc.getSelection();

                            switch(format) {
                                case 'bold':
                                    doc.replaceSelection('<strong>' + selection + '</strong>');
                                    break;
                                case 'italic':
                                    doc.replaceSelection('<em>' + selection + '</em>');
                                    break;
                                case 'link':
                                    var url = prompt('Enter URL:', 'https://');
                                    if (url) {
                                        doc.replaceSelection('<a href="' + url + '">' + (selection || 'link text') + '</a>');
                                    }
                                    break;
                                case 'ul':
                                    doc.replaceSelection('<ul>\n  <li>' + selection + '</li>\n</ul>');
                                    break;
                                case 'ol':
                                    doc.replaceSelection('<ol>\n  <li>' + selection + '</li>\n</ol>');
                                    break;
                            }

                            contentEditor.focus();
                        });
                    });
                } catch (e) {
                    console.error('Error initializing CodeMirror:', e);
                    // Fallback to regular textarea
                    contentEditor = {
                        getValue: function() {
                            return contentTextarea.value;
                        }
                    };
                }
            } else {
                // Fallback if CodeMirror is not available
                contentEditor = {
                    getValue: function() {
                        return contentTextarea ? contentTextarea.value : '';
                    }
                };
            }

            // Show/hide test email field
            var sendTestCheckbox = document.getElementById('send_test');
            var testEmailField = document.getElementById('test_email_field');

            if (sendTestCheckbox && testEmailField) {
                sendTestCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        testEmailField.classList.remove('d-none');
                    } else {
                        testEmailField.classList.add('d-none');
                    }
                });
            }

            // Preview button functionality
            var previewBtn = document.getElementById('previewBtn');
            var previewContainer = document.getElementById('preview');

            if (previewBtn && previewContainer) {
                previewBtn.addEventListener('click', function() {
                    var subjectInput = document.getElementById('subject');
                    var templateSelect = document.getElementById('template');

                    var subject = (subjectInput && subjectInput.value) ? subjectInput.value : 'Newsletter Subject';
                    var content = contentEditor.getValue() || 'Your newsletter content will appear here.';
                    var templateId = (templateSelect && templateSelect.value) ? templateSelect.value : '0';

                    // Simple preview - in a real app, you'd make an AJAX call to render the actual template
                    var previewHtml = `
                        <div class="preview-container">
                            <div class="preview-header bg-gradient-primary text-white p-3 text-center rounded-top">
                                <h3>${subject}</h3>
                            </div>
                            <div class="preview-body p-3 bg-white rounded-bottom">
                                <p>Hello there,</p>
                                <div>${content}</div>
                                <p class="mt-3">Best regards,<br>MyDay Events Team</p>
                            </div>
                        </div>
                    `;

                    previewContainer.innerHTML = previewHtml;
                });
            }

            // Confirm before sending
            var sendBtn = document.getElementById('sendBtn');
            if (sendBtn) {
                sendBtn.addEventListener('click', function(e) {
                    var activeSubscribers = {{ active_subscribers|default:"0" }};

                    if (activeSubscribers <= 0) {
                        alert('There are no active subscribers to send to.');
                        e.preventDefault();
                        return;
                    }

                    if (!confirm('Are you sure you want to send this newsletter to all selected subscribers?')) {
                        e.preventDefault();
                    }
                });
            }
        } catch (e) {
            console.error('Error initializing newsletter form:', e);
        }
    });
</script>
{% endblock %}
